<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Seguidor x Seguidor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .modal-overlay {
      background-color: rgba(17, 24, 39, 0.75);
    }
    .modal-content {
      animation: modal-in 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
    }
    @keyframes modal-in {
      0% { transform: scale(0.95); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
  </style>
</head>
<body class="bg-gray-100 antialiased font-sans text-gray-900">
  <div id="app"></div>

  <script type="module">
    // Importar los módulos de Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, query, where, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Variables globales (proporcionadas por el entorno de Canvas)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const rootElement = document.getElementById('app');
    let currentUserData = null;
    let currentView = 'login';
    let unsubscribeUser = null;
    let unsubscribeTasks = null;

    // Función para mostrar mensajes de forma temporal
    function showToast(title, icon = 'success') {
      Swal.fire({
        title: title,
        toast: true,
        position: 'bottom-end',
        showConfirmButton: false,
        timer: 3000,
        icon: icon
      });
    }

    // Función para renderizar la vista actual
    function render() {
      rootElement.innerHTML = '';
      if (currentView === 'login') {
        rootElement.innerHTML = renderLoginPage();
      } else if (currentView === 'register') {
        rootElement.innerHTML = renderRegisterPage();
      } else if (currentView === 'dashboard' && currentUserData) {
        rootElement.innerHTML = renderDashboardPage(currentUserData);
        // Volver a vincular los eventos después de renderizar
        setupDashboardListeners();
      }
      
      // Asegurar que los botones de cambio de vista funcionen
      document.getElementById('switch-to-register')?.addEventListener('click', () => {
        currentView = 'register';
        render();
      });
      document.getElementById('switch-to-login')?.addEventListener('click', () => {
        currentView = 'login';
        render();
      });
    }

    // Funciones para renderizar cada página
    function renderLoginPage(error = '') {
      return `
        <div class="flex flex-col items-center justify-center min-h-screen">
          <div class="w-full max-w-sm bg-white rounded-xl shadow-lg p-6 sm:p-8 border border-gray-200">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Iniciar Sesión</h2>
            <form id="login-form" class="space-y-4">
              <div>
                <label class="block text-gray-700 font-medium">Correo Electrónico</label>
                <input type="email" id="login-email" class="w-full mt-1 p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="tu@correo.com" required>
              </div>
              <div>
                <label class="block text-gray-700 font-medium">Contraseña</label>
                <input type="password" id="login-password" class="w-full mt-1 p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="********" required>
              </div>
              ${error ? `<p class="text-red-500 text-sm text-center">${error}</p>` : ''}
              <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-md transition duration-300 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                Entrar
              </button>
            </form>
            <p class="mt-6 text-center text-gray-600">
              ¿No tienes una cuenta?
              <button id="switch-to-register" class="text-blue-600 hover:underline font-bold">
                Regístrate aquí
              </button>
            </p>
          </div>
        </div>
      `;
    }

    function renderRegisterPage(error = '') {
      return `
        <div class="flex flex-col items-center justify-center min-h-screen">
          <div class="w-full max-w-sm bg-white rounded-xl shadow-lg p-6 sm:p-8 border border-gray-200">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Registro</h2>
            <form id="register-form" class="space-y-4">
              <div>
                <label class="block text-gray-700 font-medium">Correo Electrónico</label>
                <input type="email" id="register-email" class="w-full mt-1 p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="tu@correo.com" required>
              </div>
              <div>
                <label class="block text-gray-700 font-medium">Contraseña</label>
                <input type="password" id="register-password" class="w-full mt-1 p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="********" required>
              </div>
              <div>
                <label class="block text-gray-700 font-medium">Confirmar Contraseña</label>
                <input type="password" id="register-confirm-password" class="w-full mt-1 p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="********" required>
              </div>
              ${error ? `<p class="text-red-500 text-sm text-center">${error}</p>` : ''}
              <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-md transition duration-300 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                Registrarse
              </button>
            </form>
            <p class="mt-6 text-center text-gray-600">
              ¿Ya tienes una cuenta?
              <button id="switch-to-login" class="text-blue-600 hover:underline font-bold">
                Inicia sesión
              </button>
            </p>
          </div>
        </div>
      `;
    }

    function renderDashboardPage(user) {
      return `
        <div class="min-h-screen bg-gray-50 p-4">
          <div class="flex justify-between items-center mb-6">
            <h1 class="text-4xl font-extrabold text-blue-600">Seguidor x Seguidor</h1>
            <button id="logout-button" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-full shadow-md hover:bg-red-600 transition">
              Cerrar Sesión
            </button>
          </div>
          <div class="bg-white rounded-xl shadow-xl p-6 sm:p-8 border border-gray-200">
            <div class="flex flex-col sm:flex-row items-center sm:items-start space-y-4 sm:space-y-0 sm:space-x-8 mb-8">
              <div class="flex-shrink-0 relative">
                <img
                  src="${user.profileImageUrl || 'https://placehold.co/100x100/A0B9D6/ffffff?text=User'}"
                  alt="Profile"
                  class="w-24 h-24 rounded-full object-cover border-4 border-blue-500 shadow-md"
                />
              </div>
              <div>
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 break-all">${user.email}</h2>
                <p class="text-xl sm:text-2xl text-yellow-600 font-bold flex items-center">
                  <i class="fas fa-coins mr-2 text-yellow-500"></i>
                  <span id="user-points">${user.points || 0}</span> Puntos
                </p>
              </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6">
              <button id="promote-button" class="dashboard-btn group from-purple-500 to-purple-600">
                <div class="text-4xl text-purple-600 mb-3 group-hover:scale-110 transition-transform duration-300"><i class="fas fa-paper-plane"></i></div>
                <span class="text-center font-bold text-gray-800">Promocionar Redes</span>
              </button>
              <button id="earn-button" class="dashboard-btn group from-green-500 to-green-600">
                <div class="text-4xl text-green-600 mb-3 group-hover:scale-110 transition-transform duration-300"><i class="fas fa-tachometer-alt"></i></div>
                <span class="text-center font-bold text-gray-800">Ganar Puntos</span>
              </button>
              <button id="referral-button" class="dashboard-btn group from-blue-500 to-blue-600">
                <div class="text-4xl text-blue-600 mb-3 group-hover:scale-110 transition-transform duration-300"><i class="fas fa-user-plus"></i></div>
                <span class="text-center font-bold text-gray-800">Programa de Referidos</span>
              </button>
              <button id="buy-button" class="dashboard-btn group from-red-500 to-red-600">
                <div class="text-4xl text-red-600 mb-3 group-hover:scale-110 transition-transform duration-300"><i class="fas fa-store"></i></div>
                <span class="text-center font-bold text-gray-800">Comprar Puntos</span>
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // Funciones para manejar eventos de la interfaz
    function setupDashboardListeners() {
      document.getElementById('logout-button')?.addEventListener('click', handleLogout);
      document.getElementById('promote-button')?.addEventListener('click', openPromoteModal);
      document.getElementById('earn-button')?.addEventListener('click', openEarnPointsModal);
      document.getElementById('referral-button')?.addEventListener('click', openReferralModal);
      document.getElementById('buy-button')?.addEventListener('click', openBuyPointsModal);
    }
    
    // Funciones de modales
    function openModal(htmlContent) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay transition-opacity duration-300';
      modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg mx-auto transform scale-95 transition-transform duration-300 border border-gray-200 modal-content">
          <div class="flex justify-end p-2">
            <button class="modal-close text-gray-400 hover:text-gray-600 transition">
              <i class="fas fa-times h-6 w-6"></i>
            </button>
          </div>
          <div class="p-6">${htmlContent}</div>
        </div>
      `;
      document.body.appendChild(modal);
      modal.querySelector('.modal-close').addEventListener('click', () => modal.remove());
    }

    function openPromoteModal() {
      openModal(`
        <h3 class="text-2xl font-bold mb-4">Promociona tus redes</h3>
        <p class="mb-4">Selecciona una red social y el valor en puntos. Los puntos se descontarán de tu saldo cuando crees la tarea.</p>
        <div id="social-buttons" class="flex flex-wrap gap-4 justify-center mb-6">
          <button data-network="Facebook" data-points="3" class="social-btn flex flex-col items-center p-4 rounded-xl transition bg-gray-100 hover:bg-gray-200 border border-gray-300"><div class="text-3xl text-blue-600"><i class="fab fa-facebook-f"></i></div><span class="text-sm font-semibold mt-2">Facebook</span><span class="text-xs text-gray-500">3 pts</span></button>
          <button data-network="Instagram" data-points="4" class="social-btn flex flex-col items-center p-4 rounded-xl transition bg-gray-100 hover:bg-gray-200 border border-gray-300"><div class="text-3xl text-pink-500"><i class="fab fa-instagram"></i></div><span class="text-sm font-semibold mt-2">Instagram</span><span class="text-xs text-gray-500">4 pts</span></button>
          <button data-network="X" data-points="4" class="social-btn flex flex-col items-center p-4 rounded-xl transition bg-gray-100 hover:bg-gray-200 border border-gray-300"><div class="text-3xl text-gray-900"><i class="fab fa-twitter"></i></div><span class="text-sm font-semibold mt-2">X</span><span class="text-xs text-gray-500">4 pts</span></button>
          <button data-network="Reddit" data-points="5" class="social-btn flex flex-col items-center p-4 rounded-xl transition bg-gray-100 hover:bg-gray-200 border border-gray-300"><div class="text-3xl text-orange-500"><i class="fab fa-reddit"></i></div><span class="text-sm font-semibold mt-2">Reddit</span><span class="text-xs text-gray-500">5 pts</span></button>
          <button data-network="YouTube" data-points="6" class="social-btn flex flex-col items-center p-4 rounded-xl transition bg-gray-100 hover:bg-gray-200 border border-gray-300"><div class="text-3xl text-red-600"><i class="fab fa-youtube"></i></div><span class="text-sm font-semibold mt-2">YouTube</span><span class="text-xs text-gray-500">6 pts</span></button>
        </div>
        <input type="url" id="promote-link" placeholder="Copia el enlace de tu perfil aquí" class="w-full p-3 border border-gray-300 rounded-md mb-4" required>
        <button id="promote-submit" class="w-full bg-purple-600 text-white font-bold py-3 rounded-md hover:bg-purple-700 transition">
          Promocionar (3 puntos)
        </button>
      `);

      const socialBtns = document.querySelectorAll('.social-btn');
      let selectedNetwork = 'Facebook';
      let selectedPoints = 3;

      socialBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          socialBtns.forEach(b => b.classList.remove('bg-blue-100', 'border-2', 'border-blue-500', 'shadow-md'));
          btn.classList.add('bg-blue-100', 'border-2', 'border-blue-500', 'shadow-md');
          selectedNetwork = btn.dataset.network;
          selectedPoints = parseInt(btn.dataset.points, 10);
          document.getElementById('promote-submit').textContent = `Promocionar (${selectedPoints} puntos)`;
        });
      });
      socialBtns[0].click(); // Seleccionar por defecto

      document.getElementById('promote-submit').addEventListener('click', async () => {
        const link = document.getElementById('promote-link').value;
        if (!link) {
          showToast('Por favor, ingresa un enlace.', 'error');
          return;
        }
        if (currentUserData.points < selectedPoints) {
          showToast('No tienes suficientes puntos.', 'error');
          return;
        }

        const taskCollectionRef = collection(db, `/artifacts/${appId}/public/data/tasks`);
        try {
          const userRef = doc(db, 'users', currentUserData.uid);
          await updateDoc(userRef, { points: currentUserData.points - selectedPoints });

          await addDoc(taskCollectionRef, {
            userId: currentUserData.uid,
            network: selectedNetwork,
            link: link,
            points: selectedPoints,
            createdAt: new Date(),
          });
          document.querySelector('.modal-overlay').remove();
          showToast(`¡Promoción en ${selectedNetwork} agregada!`);
        } catch (e) {
          console.error('Error adding task:', e);
          showToast('Error al agregar la tarea.', 'error');
        }
      });
    }

    function openEarnPointsModal() {
      openModal(`
        <h3 class="text-2xl font-bold mb-4">Gana Puntos</h3>
        <p class="mb-4">Completa las siguientes tareas para ganar puntos.</p>
        <div id="tasks-list" class="space-y-4 max-h-96 overflow-y-auto">
          <p class="text-center text-gray-500">Cargando tareas...</p>
        </div>
      `);

      const tasksListDiv = document.getElementById('tasks-list');
      const q = query(collection(db, `/artifacts/${appId}/public/data/tasks`), where('userId', '!=', currentUserData.uid));
      
      unsubscribeTasks = onSnapshot(q, (querySnapshot) => {
        let tasksHtml = '';
        if (querySnapshot.empty) {
          tasksHtml = '<p class="text-center text-gray-500">No hay tareas disponibles en este momento. ¡Vuelve más tarde!</p>';
        } else {
          querySnapshot.forEach((doc) => {
            const task = doc.data();
            const taskId = doc.id;
            let iconClass = '';
            if (task.network === 'Facebook') iconClass = 'fab fa-facebook-f text-blue-600';
            else if (task.network === 'Instagram') iconClass = 'fab fa-instagram text-pink-500';
            else if (task.network === 'X') iconClass = 'fab fa-twitter text-gray-900';
            else if (task.network === 'Reddit') iconClass = 'fab fa-reddit text-orange-500';
            else if (task.network === 'YouTube') iconClass = 'fab fa-youtube text-red-600';

            tasksHtml += `
              <div class="bg-gray-100 p-4 rounded-lg flex items-center justify-between">
                <div class="flex items-center space-x-3">
                  <div class="text-xl"><i class="${iconClass}"></i></div>
                  <div>
                    <p class="font-semibold">${task.network}</p>
                    <a href="${task.link}" target="_blank" rel="noopener noreferrer" class="text-sm text-blue-500 hover:underline">
                      Visitar <i class="fas fa-link inline-block text-xs ml-1"></i>
                    </a>
                  </div>
                </div>
                <div class="flex items-center space-x-2">
                  <span class="text-lg font-bold text-green-600"> +${task.points}</span>
                  <button data-task-id="${taskId}" data-points="${task.points}" class="complete-task-btn bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 transition">
                    Completar
                  </button>
                </div>
              </div>
            `;
          });
        }
        tasksListDiv.innerHTML = tasksHtml;

        document.querySelectorAll('.complete-task-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const taskId = e.target.dataset.taskId;
            const taskPoints = parseInt(e.target.dataset.points, 10);

            const taskRef = doc(db, `/artifacts/${appId}/public/data/tasks`, taskId);
            const userRef = doc(db, 'users', currentUserData.uid);
            
            try {
              await updateDoc(userRef, { points: currentUserData.points + taskPoints });
              await deleteDoc(taskRef);
              showToast(`¡Tarea completada! Ganaste ${taskPoints} puntos.`);
            } catch (e) {
              console.error('Error completing task:', e);
              showToast('Error al completar la tarea.', 'error');
            }
          });
        });
      });
    }

    function openReferralModal() {
      const referralLink = `${window.location.origin}?ref=${currentUserData.referralCode}`;
      openModal(`
        <div class="p-6 text-center">
          <h3 class="text-2xl font-bold mb-4">Programa de Referidos</h3>
          <p class="mb-4">Comparte este enlace único con tus amigos. Cuando se registren, ambos ganarán <span class="font-bold text-yellow-500">10 puntos</span>.</p>
          <div class="bg-gray-200 rounded-md p-4 flex items-center justify-between mb-4">
            <input type="text" readonly value="${referralLink}" id="referral-link" class="flex-grow bg-transparent border-none outline-none text-sm text-gray-700">
            <button id="copy-referral" class="ml-2 text-blue-600 hover:text-blue-800">
              <i class="fas fa-link w-6 h-6"></i>
            </button>
          </div>
          <div class="flex justify-center space-x-4">
            <a href="https://wa.me/?text=${encodeURIComponent(`Únete a Seguidor x Seguidor y gana puntos. Usa mi enlace de referido: ${referralLink}`)}" target="_blank" rel="noopener noreferrer" class="text-green-500 hover:text-green-600">
              <i class="fab fa-whatsapp w-8 h-8"></i>
            </a>
            <a href="https://t.me/share/url?url=${encodeURIComponent(referralLink)}&text=${encodeURIComponent('Únete a Seguidor x Seguidor y gana puntos. ¡Es gratis!')}" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:text-blue-600">
              <i class="fab fa-telegram w-8 h-8"></i>
            </a>
          </div>
        </div>
      `);
      document.getElementById('copy-referral').addEventListener('click', () => {
        const linkInput = document.getElementById('referral-link');
        linkInput.select();
        document.execCommand('copy');
        showToast('¡Enlace de referido copiado!');
      });
    }

    function openBuyPointsModal() {
      openModal(`
        <div class="p-6 text-center">
          <h3 class="text-2xl font-bold mb-4">Comprar Puntos</h3>
          <p class="text-gray-600">
            Esta función aún no está disponible. Estamos trabajando para integrar un sistema de pago seguro para que puedas comprar puntos fácilmente.
          </p>
        </div>
      `);
    }

    // Funciones de autenticación y datos
    async function handleLogin(email, password) {
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (error) {
        showToast('Credenciales incorrectas.', 'error');
      }
    }

    async function handleRegister(email, password) {
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const uid = userCredential.user.uid;
        const userDocRef = doc(db, 'users', uid);
        await setDoc(userDocRef, {
          points: 20,
          email: email,
          profileImageUrl: '',
          referralCode: uid.substring(0, 8),
        });
        showToast('¡Registro exitoso!');
      } catch (error) {
        showToast('Error en el registro. ' + (error.message || 'Por favor, inténtalo de nuevo.'), 'error');
      }
    }
    
    async function handleLogout() {
      try {
        await signOut(auth);
        if (unsubscribeUser) unsubscribeUser();
        if (unsubscribeTasks) unsubscribeTasks();
        currentUserData = null;
        currentView = 'login';
        render();
      } catch (error) {
        console.error('Error signing out:', error);
      }
    }

    // Escuchar cambios en el estado de autenticación
    onAuthStateChanged(auth, (user) => {
      if (user) {
        const userRef = doc(db, 'users', user.uid);
        unsubscribeUser = onSnapshot(userRef, (docSnap) => {
          if (docSnap.exists()) {
            currentUserData = { ...user, ...docSnap.data() };
            currentView = 'dashboard';
            render();
          } else {
            // El usuario existe pero el documento no, podría ser un error de inicialización
            // Se puede manejar aquí o simplemente esperar a que el documento se cree al registrar
            currentUserData = { uid: user.uid, email: user.email, points: 0, profileImageUrl: '', referralCode: '' };
            currentView = 'dashboard';
            render();
          }
        });
      } else {
        if (unsubscribeUser) unsubscribeUser();
        if (unsubscribeTasks) unsubscribeTasks();
        currentUserData = null;
        currentView = 'login';
        render();
      }
    });

    // Escuchar eventos del formulario
    document.addEventListener('submit', (e) => {
      e.preventDefault();
      if (e.target.id === 'login-form') {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        handleLogin(email, password);
      } else if (e.target.id === 'register-form') {
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        const confirmPassword = document.getElementById('register-confirm-password').value;
        if (password === confirmPassword) {
          handleRegister(email, password);
        } else {
          showToast('Las contraseñas no coinciden.', 'error');
        }
      }
    });

    // Iniciar la aplicación
    render();

  </script>
</body>
</html>
